<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Profile - Smart Parenting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f5f7fb;
            color: #333;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 24px;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Content */
        .content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Back Button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }

        /* Child Profile Header */
        .child-header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .child-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 600;
        }

        .child-info h2 {
            font-size: 32px;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .child-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-item h4 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .detail-item p {
            font-size: 18px;
            font-weight: 500;
            color: var(--dark);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab i {
            display: block;
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }

        /* Health Stats */
        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-card p {
            color: var(--gray);
            font-size: 14px;
        }

        /* Chart Container */
        .chart-container {
            height: 300px;
            margin-bottom: 30px;
            position: relative;
        }

        /* Records Table */
        .records-table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #eee;
        }

        .records-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        /* Add Record Button */
        .add-record-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .add-record-btn:hover {
            background: var(--secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 30px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--secondary);
        }

        .btn-block {
            width: 100%;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .content {
                padding: 20px;
            }
            
            .child-header {
                flex-direction: column;
                text-align: center;
                padding: 30px 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .child-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-child"></i>
            <h1>Smart Parenting</h1>
        </div>
        
        <div class="header-actions">
            <a href="#" class="back-button" id="backButton">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <h4 id="userName">User</h4>
                    <p id="userRole">Role</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Content -->
    <div class="content">
        <!-- Child Profile Header -->
        <div class="child-header" id="childHeader">
            <div class="child-avatar-large" id="childAvatar">C</div>
            <div class="child-info">
                <h2 id="childName">Child Name</h2>
                <div class="child-details" id="childDetails">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="health">
                <i class="fas fa-heartbeat"></i>
                <span>Health Tracker</span>
            </div>
            <div class="tab" data-tab="education">
                <i class="fas fa-graduation-cap"></i>
                <span>Education</span>
            </div>
            <div class="tab" data-tab="activities">
                <i class="fas fa-running"></i>
                <span>Activities</span>
            </div>
            <div class="tab" data-tab="overview">
                <i class="fas fa-chart-line"></i>
                <span>Overview</span>
            </div>
        </div>

        <!-- Health Tab -->
        <div class="tab-content active" id="healthTab">
            <div class="section-title">
                <h3>Health Records</h3>
                <button class="add-record-btn" id="addHealthRecordBtn">
                    <i class="fas fa-plus"></i> Add Health Record
                </button>
            </div>
            
            <div class="health-stats">
                <div class="stat-card">
                    <h3 id="currentWeight">0</h3>
                    <p>Current Weight (kg)</p>
                </div>
                <div class="stat-card">
                    <h3 id="currentHeight">0</h3>
                    <p>Current Height (cm)</p>
                </div>
                <div class="stat-card">
                    <h3 id="bmiScore">0</h3>
                    <p>BMI Score</p>
                </div>
                <div class="stat-card">
                    <h3 id="healthScore">0%</h3>
                    <p>Health Score</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="healthChart"></canvas>
            </div>
            
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Weight (kg)</th>
                        <th>Height (cm)</th>
                        <th>BMI</th>
                        <th>Vaccination</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="healthRecordsTable">
                    <!-- Records will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Education Tab -->
        <div class="tab-content" id="educationTab">
            <div class="section-title">
                <h3>Education Records</h3>
                <button class="add-record-btn" id="addEducationRecordBtn">
                    <i class="fas fa-plus"></i> Add Education Record
                </button>
            </div>
            
            <div class="health-stats">
                <div class="stat-card">
                    <h3 id="avgMarks">0%</h3>
                    <p>Average Marks</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSubjects">0</h3>
                    <p>Subjects</p>
                </div>
                <div class="stat-card">
                    <h3 id="educationScore">0%</h3>
                    <p>Education Score</p>
                </div>
                <div class="stat-card">
                    <h3 id="latestGrade">-</h3>
                    <p>Latest Grade</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="educationChart"></canvas>
            </div>
            
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Marks/Grade</th>
                        <th>Type</th>
                        <th>Teacher Feedback</th>
                    </tr>
                </thead>
                <tbody id="educationRecordsTable">
                    <!-- Records will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Activities Tab -->
        <div class="tab-content" id="activitiesTab">
            <div class="section-title">
                <h3>Daily Activities</h3>
                <button class="add-record-btn" id="addActivityRecordBtn">
                    <i class="fas fa-plus"></i> Add Activity
                </button>
            </div>
            
            <div class="health-stats">
                <div class="stat-card">
                    <h3 id="totalActivities">0</h3>
                    <p>Total Activities</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgDuration">0</h3>
                    <p>Avg Duration (min)</p>
                </div>
                <div class="stat-card">
                    <h3 id="studyHours">0</h3>
                    <p>Study Hours</p>
                </div>
                <div class="stat-card">
                    <h3 id="playHours">0</h3>
                    <p>Play Hours</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="activitiesChart"></canvas>
            </div>
            
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Activity</th>
                        <th>Type</th>
                        <th>Duration</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="activitiesRecordsTable">
                    <!-- Records will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content" id="overviewTab">
            <div class="section-title">
                <h3>Development Overview</h3>
            </div>
            
            <div class="health-stats">
                <div class="stat-card">
                    <h3 id="overallScore">0%</h3>
                    <p>Overall Score</p>
                </div>
                <div class="stat-card">
                    <h3 id="ageYears">0</h3>
                    <p>Age (Years)</p>
                </div>
                <div class="stat-card">
                    <h3 id="growthPercentile">50%</h3>
                    <p>Growth Percentile</p>
                </div>
                <div class="stat-card">
                    <h3 id="milestones">0</h3>
                    <p>Milestones</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="overviewChart"></canvas>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px;">Recent Suggestions from Expert</h4>
                <div id="expertSuggestions">
                    <!-- Suggestions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Health Record Modal -->
    <div class="modal" id="addHealthModal">
        <div class="modal-content">
            <button class="close-modal" id="closeHealthModal">&times;</button>
            <h2>Add Health Record</h2>
            <form id="addHealthForm">
                <div class="form-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="healthWeight" step="0.1" required>
                </div>
                
                <div class="form-group">
                    <label>Height (cm)</label>
                    <input type="number" id="healthHeight" step="0.1" required>
                </div>
                
                <div class="form-group">
                    <label>Vaccination Status</label>
                    <select id="vaccinationStatus">
                        <option value="up-to-date">Up to Date</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Health Notes</label>
                    <textarea id="healthNotes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn btn-block">Save Health Record</button>
            </form>
        </div>
    </div>

    <!-- Add Education Record Modal -->
    <div class="modal" id="addEducationModal">
        <div class="modal-content">
            <button class="close-modal" id="closeEducationModal">&times;</button>
            <h2>Add Education Record</h2>
            <form id="addEducationForm">
                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" id="educationSubject" required>
                </div>
                
                <div class="form-group">
                    <label>Marks/Grade</label>
                    <input type="text" id="educationMarks" required>
                </div>
                
                <div class="form-group">
                    <label>Exam Type</label>
                    <select id="examType">
                        <option value="test">Test</option>
                        <option value="exam">Exam</option>
                        <option value="assignment">Assignment</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="educationDate" required>
                </div>
                
                <div class="form-group">
                    <label>Teacher Feedback</label>
                    <textarea id="educationFeedback" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn btn-block">Save Education Record</button>
            </form>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal" id="addActivityModal">
        <div class="modal-content">
            <button class="close-modal" id="closeActivityModal">&times;</button>
            <h2>Add Activity</h2>
            <form id="addActivityForm">
                <div class="form-group">
                    <label>Activity Type</label>
                    <select id="activityType" required>
                        <option value="study">Study</option>
                        <option value="play">Play</option>
                        <option value="sports">Sports</option>
                        <option value="creative">Creative</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Activity Description</label>
                    <input type="text" id="activityDescription" required>
                </div>
                
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="activityDuration" required>
                </div>
                
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="activityDate" required>
                </div>
                
                <button type="submit" class="btn btn-block">Save Activity</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class ChildProfile {
            constructor() {
                this.childId = null;
                this.child = null;
                this.currentUser = null;
                this.initialize();
            }
            
            initialize() {
                this.checkAuthentication();
                this.loadChild();
                this.setupEventListeners();
                this.loadHealthData();
                this.loadEducationData();
                this.loadActivitiesData();
                this.updateOverview();
            }
            
            checkAuthentication() {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.currentUser = user;
                this.childId = localStorage.getItem('selectedChildId');
                
                if (!this.childId) {
                    this.redirectToDashboard();
                    return;
                }
                
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
            }
            
            loadChild() {
                const children = JSON.parse(localStorage.getItem('children') || '[]');
                this.child = children.find(c => c.id === this.childId);
                
                if (!this.child) {
                    alert('Child not found');
                    this.redirectToDashboard();
                    return;
                }
                
                // Check if user has permission to view this child
                if (this.currentUser.role === 'parent' && this.child.parentId !== this.currentUser.id) {
                    alert('You do not have permission to view this child');
                    this.redirectToDashboard();
                    return;
                }
                
                // For experts, check if they are assigned to this child's parent
                if (this.currentUser.role === 'expert') {
                    const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
                    const isAssigned = assignments.some(a => 
                        a.expertId === this.currentUser.id && 
                        a.parentId === this.child.parentId
                    );
                    
                    if (!isAssigned && this.currentUser.role !== 'admin') {
                        alert('You are not assigned to this child');
                        this.redirectToDashboard();
                        return;
                    }
                }
                
                this.updateChildHeader();
            }
            
            updateChildHeader() {
                document.getElementById('childName').textContent = this.child.name;
                document.getElementById('childAvatar').textContent = this.child.name.charAt(0);
                
                const age = this.calculateAge(this.child.dob);
                const details = document.getElementById('childDetails');
                details.innerHTML = `
                    <div class="detail-item">
                        <h4>Age</h4>
                        <p>${age} years</p>
                    </div>
                    <div class="detail-item">
                        <h4>Gender</h4>
                        <p>${this.child.gender || 'Not specified'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Date of Birth</h4>
                        <p>${new Date(this.child.dob).toLocaleDateString()}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Initial Weight</h4>
                        <p>${this.child.weight || 'N/A'} kg</p>
                    </div>
                    <div class="detail-item">
                        <h4>Initial Height</h4>
                        <p>${this.child.height || 'N/A'} cm</p>
                    </div>
                `;
                
                document.getElementById('ageYears').textContent = age;
            }
            
            calculateAge(dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            }
            
            setupEventListeners() {
                // Back button
                document.getElementById('backButton').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.redirectToDashboard();
                });
                
                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Add record buttons
                document.getElementById('addHealthRecordBtn').addEventListener('click', () => {
                    if (this.currentUser.role !== 'parent') {
                        alert('Only parents can add health records');
                        return;
                    }
                    this.showAddHealthModal();
                });
                
                document.getElementById('addEducationRecordBtn').addEventListener('click', () => {
                    if (this.currentUser.role !== 'parent') {
                        alert('Only parents can add education records');
                        return;
                    }
                    this.showAddEducationModal();
                });
                
                document.getElementById('addActivityRecordBtn').addEventListener('click', () => {
                    if (this.currentUser.role !== 'parent') {
                        alert('Only parents can add activities');
                        return;
                    }
                    this.showAddActivityModal();
                });
                
                // Modal close buttons
                document.getElementById('closeHealthModal').addEventListener('click', () => {
                    document.getElementById('addHealthModal').classList.remove('active');
                });
                
                document.getElementById('closeEducationModal').addEventListener('click', () => {
                    document.getElementById('addEducationModal').classList.remove('active');
                });
                
                document.getElementById('closeActivityModal').addEventListener('click', () => {
                    document.getElementById('addActivityModal').classList.remove('active');
                });
                
                // Form submissions
                document.getElementById('addHealthForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addHealthRecord();
                });
                
                document.getElementById('addEducationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addEducationRecord();
                });
                
                document.getElementById('addActivityForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addActivity();
                });
                
                // Close modals when clicking outside
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }
            
            switchTab(tabId) {
                // Update active tab
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === tabId) {
                        tab.classList.add('active');
                    }
                });
                
                // Show corresponding tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId + 'Tab') {
                        content.classList.add('active');
                    }
                });
                
                // Load tab-specific data
                if (tabId === 'health') {
                    this.loadHealthData();
                } else if (tabId === 'education') {
                    this.loadEducationData();
                } else if (tabId === 'activities') {
                    this.loadActivitiesData();
                } else if (tabId === 'overview') {
                    this.updateOverview();
                }
            }
            
            loadHealthData() {
                const records = JSON.parse(localStorage.getItem('healthRecords') || '[]')
                    .filter(record => record.childId === this.childId)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (records.length === 0) {
                    document.getElementById('healthRecordsTable').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-heartbeat" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                No health records yet
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Update current stats
                const latest = records[records.length - 1];
                document.getElementById('currentWeight').textContent = latest.weight || '0';
                document.getElementById('currentHeight').textContent = latest.height || '0';
                
                // Calculate BMI
                const heightInMeters = (latest.height || 1) / 100;
                const bmi = heightInMeters > 0 ? (latest.weight || 0) / (heightInMeters * heightInMeters) : 0;
                document.getElementById('bmiScore').textContent = bmi.toFixed(1);
                
                // Calculate health score
                const healthScore = this.calculateHealthScore(records);
                                document.getElementById('healthScore').textContent = healthScore + '%';
                
                // Update table
                const table = document.getElementById('healthRecordsTable');
                table.innerHTML = records.map(record => {
                    const recordBMI = (record.height || 1) > 0 ? 
                        (record.weight || 0) / ((record.height/100) * (record.height/100)) : 0;
                    
                    return `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString()}</td>
                            <td>${record.weight || 'N/A'}</td>
                            <td>${record.height || 'N/A'}</td>
                            <td>${recordBMI.toFixed(1)}</td>
                            <td>${record.vaccination || 'N/A'}</td>
                            <td>${record.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                // Create health chart
                this.createHealthChart(records);
            }
            
            calculateHealthScore(records) {
                if (records.length === 0) return 0;
                
                const latest = records[records.length - 1];
                const heightInMeters = (latest.height || 1) / 100;
                const bmi = heightInMeters > 0 ? (latest.weight || 0) / (heightInMeters * heightInMeters) : 0;
                
                let score = 85; // Base score
                
                // Simple BMI-based scoring
                if (bmi < 18.5) score = 70;
                else if (bmi >= 18.5 && bmi <= 24.9) score = 95;
                else if (bmi > 24.9 && bmi <= 29.9) score = 75;
                else if (bmi > 29.9) score = 60;
                
                // Consider vaccination status
                if (latest.vaccination === 'up-to-date') score += 5;
                else if (latest.vaccination === 'overdue') score -= 10;
                
                return Math.min(100, Math.max(0, score));
            }
            
            createHealthChart(records) {
                const ctx = document.getElementById('healthChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.healthChart) {
                    window.healthChart.destroy();
                }
                
                const dates = records.map(r => new Date(r.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const weights = records.map(r => r.weight);
                const heights = records.map(r => r.height);
                
                window.healthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Weight (kg)',
                                data: weights,
                                borderColor: '#4361ee',
                                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Height (cm)',
                                data: heights,
                                borderColor: '#f72585',
                                backgroundColor: 'rgba(247, 37, 133, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Weight (kg)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Height (cm)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Growth Chart'
                            }
                        }
                    }
                });
            }
            
            loadEducationData() {
                const records = JSON.parse(localStorage.getItem('educationRecords') || '[]')
                    .filter(record => record.childId === this.childId)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (records.length === 0) {
                    document.getElementById('educationRecordsTable').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-graduation-cap" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                No education records yet
                            </td>
                        </tr>
                    `;
                    
                    document.getElementById('avgMarks').textContent = '0%';
                    document.getElementById('totalSubjects').textContent = '0';
                    document.getElementById('educationScore').textContent = '0%';
                    document.getElementById('latestGrade').textContent = '-';
                    
                    return;
                }
                
                // Calculate statistics
                const marks = records.map(r => parseInt(r.marks) || 0);
                const avgMarks = marks.reduce((a, b) => a + b, 0) / marks.length;
                const uniqueSubjects = [...new Set(records.map(r => r.subject))];
                const latestRecord = records[records.length - 1];
                
                document.getElementById('avgMarks').textContent = Math.round(avgMarks) + '%';
                document.getElementById('totalSubjects').textContent = uniqueSubjects.length;
                document.getElementById('educationScore').textContent = Math.round(avgMarks) + '%';
                document.getElementById('latestGrade').textContent = latestRecord.marks;
                
                // Update table
                const table = document.getElementById('educationRecordsTable');
                table.innerHTML = records.map(record => {
                    return `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString()}</td>
                            <td>${record.subject}</td>
                            <td>${record.marks}</td>
                            <td>${record.examType || 'N/A'}</td>
                            <td>${record.feedback || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                // Create education chart
                this.createEducationChart(records);
            }
            
            createEducationChart(records) {
                const ctx = document.getElementById('educationChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.educationChart) {
                    window.educationChart.destroy();
                }
                
                // Group by subject
                const subjects = [...new Set(records.map(r => r.subject))];
                const subjectData = {};
                
                subjects.forEach(subject => {
                    const subjectRecords = records.filter(r => r.subject === subject)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                    subjectData[subject] = {
                        labels: subjectRecords.map(r => new Date(r.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        marks: subjectRecords.map(r => parseInt(r.marks) || 0)
                    };
                });
                
                // For simplicity, show first 3 subjects
                const displaySubjects = subjects.slice(0, 3);
                
                const datasets = displaySubjects.map((subject, index) => {
                    const colors = ['#4361ee', '#f72585', '#4cc9f0', '#7209b7', '#ffd166'];
                    return {
                        label: subject,
                        data: subjectData[subject]?.marks || [],
                        borderColor: colors[index % colors.length],
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.4
                    };
                });
                
                const labels = displaySubjects.length > 0 ? subjectData[displaySubjects[0]]?.labels || [] : [];
                
                window.educationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Marks (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Academic Performance'
                            }
                        }
                    }
                });
            }
            
            loadActivitiesData() {
                const records = JSON.parse(localStorage.getItem('activities') || '[]')
                    .filter(record => record.childId === this.childId)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (records.length === 0) {
                    document.getElementById('activitiesRecordsTable').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-running" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                No activities recorded yet
                            </td>
                        </tr>
                    `;
                    
                    document.getElementById('totalActivities').textContent = '0';
                    document.getElementById('avgDuration').textContent = '0';
                    document.getElementById('studyHours').textContent = '0';
                    document.getElementById('playHours').textContent = '0';
                    
                    return;
                }
                
                // Calculate statistics
                const totalDuration = records.reduce((sum, r) => sum + (parseInt(r.duration) || 0), 0);
                const avgDuration = Math.round(totalDuration / records.length);
                const studyHours = Math.round(records.filter(r => r.type === 'study')
                    .reduce((sum, r) => sum + (parseInt(r.duration) || 0), 0) / 60);
                const playHours = Math.round(records.filter(r => r.type === 'play' || r.type === 'sports')
                    .reduce((sum, r) => sum + (parseInt(r.duration) || 0), 0) / 60);
                
                document.getElementById('totalActivities').textContent = records.length;
                document.getElementById('avgDuration').textContent = avgDuration;
                document.getElementById('studyHours').textContent = studyHours;
                document.getElementById('playHours').textContent = playHours;
                
                // Update table
                const table = document.getElementById('activitiesRecordsTable');
                table.innerHTML = records.slice(-10).reverse().map(record => {
                    return `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString()}</td>
                            <td>${record.description}</td>
                            <td>${record.type}</td>
                            <td>${record.duration} min</td>
                            <td>${record.description || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                // Create activities chart
                this.createActivitiesChart(records);
            }
            
            createActivitiesChart(records) {
                const ctx = document.getElementById('activitiesChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.activitiesChart) {
                    window.activitiesChart.destroy();
                }
                
                // Group by type and date
                const types = ['study', 'play', 'sports', 'creative', 'social'];
                const last7Days = Array.from({length: 7}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    return date.toISOString().split('T')[0];
                }).reverse();
                
                const typeColors = {
                    'study': '#4361ee',
                    'play': '#f72585',
                    'sports': '#4cc9f0',
                    'creative': '#7209b7',
                    'social': '#ffd166'
                };
                
                const datasets = types.map(type => {
                    const data = last7Days.map(day => {
                        const dayRecords = records.filter(r => r.date === day && r.type === type);
                        return dayRecords.reduce((sum, r) => sum + (parseInt(r.duration) || 0), 0) / 60; // Convert to hours
                    });
                    
                    return {
                        label: type.charAt(0).toUpperCase() + type.slice(1),
                        data: data,
                        backgroundColor: typeColors[type],
                        stack: 'stack'
                    };
                });
                
                const labels = last7Days.map(day => {
                    const date = new Date(day);
                    return date.toLocaleDateString('en-US', { weekday: 'short' });
                });
                
                window.activitiesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Weekly Activity Breakdown'
                            }
                        }
                    }
                });
            }
            
            updateOverview() {
                // Calculate overall score
                const healthScore = this.calculateHealthScore(
                    JSON.parse(localStorage.getItem('healthRecords') || '[]')
                        .filter(r => r.childId === this.childId)
                );
                
                const educationRecords = JSON.parse(localStorage.getItem('educationRecords') || '[]')
                    .filter(r => r.childId === this.childId);
                const educationScore = educationRecords.length > 0 ?
                    Math.round(educationRecords.reduce((sum, r) => sum + (parseInt(r.marks) || 0), 0) / educationRecords.length) : 0;
                
                const activities = JSON.parse(localStorage.getItem('activities') || '[]')
                    .filter(r => r.childId === this.childId);
                const activityScore = activities.length > 0 ? 
                    Math.min(100, activities.length * 10) : 0;
                
                const overallScore = Math.round((healthScore + educationScore + activityScore) / 3);
                
                document.getElementById('overallScore').textContent = overallScore + '%';
                
                // Growth percentile (simplified)
                const age = this.calculateAge(this.child.dob);
                const latestHealth = JSON.parse(localStorage.getItem('healthRecords') || '[]')
                    .filter(r => r.childId === this.childId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                let growthPercentile = 50; // Default
                if (latestHealth && latestHealth.height && latestHealth.weight) {
                    // Very simplified percentile calculation (for demo only)
                    const heightPercentile = (latestHealth.height / (100 + age * 6)) * 100;
                    const weightPercentile = (latestHealth.weight / (15 + age * 2)) * 100;
                    growthPercentile = Math.round((heightPercentile + weightPercentile) / 2);
                    growthPercentile = Math.min(100, Math.max(0, growthPercentile));
                }
                
                document.getElementById('growthPercentile').textContent = growthPercentile + '%';
                
                // Milestones
                const milestones = this.calculateMilestones();
                document.getElementById('milestones').textContent = milestones.achieved;
                
                // Create overview chart
                this.createOverviewChart(healthScore, educationScore, activityScore);
                
                // Load expert suggestions
                this.loadExpertSuggestions();
            }
            
            calculateMilestones() {
                const age = this.calculateAge(this.child.dob);
                const educationRecords = JSON.parse(localStorage.getItem('educationRecords') || '[]')
                    .filter(r => r.childId === this.childId);
                const activities = JSON.parse(localStorage.getItem('activities') || '[]')
                    .filter(r => r.childId === this.childId);
                
                // Simplified milestone calculation
                let achieved = 0;
                const total = 5;
                
                if (age >= 1) achieved++;
                if (educationRecords.length >= 3) achieved++;
                if (activities.length >= 10) achieved++;
                if (age >= 3) achieved++;
                if (educationRecords.some(r => parseInt(r.marks) >= 90)) achieved++;
                
                return { achieved, total };
            }
            
            createOverviewChart(healthScore, educationScore, activityScore) {
                const ctx = document.getElementById('overviewChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.overviewChart) {
                    window.overviewChart.destroy();
                }
                
                window.overviewChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Health', 'Education', 'Activities', 'Growth', 'Development'],
                        datasets: [{
                            label: 'Current Score',
                            data: [
                                healthScore,
                                educationScore,
                                Math.min(100, activityScore),
                                75, // Growth score (simplified)
                                70  // Development score (simplified)
                            ],
                            backgroundColor: 'rgba(67, 97, 238, 0.2)',
                            borderColor: '#4361ee',
                            borderWidth: 2
                        }, {
                            label: 'Target Score',
                            data: [90, 85, 80, 90, 85],
                            backgroundColor: 'rgba(247, 37, 133, 0.2)',
                            borderColor: '#f72585',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Development Radar Chart'
                            }
                        }
                    }
                });
            }
            
            loadExpertSuggestions() {
                const suggestions = JSON.parse(localStorage.getItem('suggestions') || '[]')
                    .filter(s => s.childId === this.childId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                const container = document.getElementById('expertSuggestions');
                
                if (suggestions.length === 0) {
                    container.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; color: var(--gray);">
                            <i class="fas fa-lightbulb" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            No expert suggestions yet
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = suggestions.map(suggestion => {
                    return `
                        <div style="background: white; border-left: 4px solid var(--warning); padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h5 style="color: var(--dark); margin: 0;">${suggestion.title}</h5>
                                <span style="font-size: 12px; color: var(--gray);">${new Date(suggestion.date).toLocaleDateString()}</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">${suggestion.details}</p>
                            <div style="display: flex; gap: 10px;">
                                <span style="background: #f8f9fa; padding: 4px 12px; border-radius: 20px; font-size: 12px; color: var(--dark);">
                                    ${suggestion.category}
                                </span>
                                <span style="background: ${suggestion.priority === 'high' ? '#f8d7da' : (suggestion.priority === 'medium' ? '#fff3cd' : '#d4edda')}; 
                                      padding: 4px 12px; border-radius: 20px; font-size: 12px; 
                                      color: ${suggestion.priority === 'high' ? '#721c24' : (suggestion.priority === 'medium' ? '#856404' : '#155724')};">
                                    ${suggestion.priority} priority
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showAddHealthModal() {
                document.getElementById('addHealthModal').classList.add('active');
                document.getElementById('healthWeight').focus();
            }
            
            showAddEducationModal() {
                document.getElementById('addEducationModal').classList.add('active');
                document.getElementById('educationSubject').focus();
                // Set default date to today
                document.getElementById('educationDate').value = new Date().toISOString().split('T')[0];
            }
            
            showAddActivityModal() {
                document.getElementById('addActivityModal').classList.add('active');
                document.getElementById('activityDescription').focus();
                // Set default date to today
                document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
            }
            
            addHealthRecord() {
                const record = {
                    id: 'health_' + Date.now(),
                    childId: this.childId,
                    weight: parseFloat(document.getElementById('healthWeight').value),
                    height: parseFloat(document.getElementById('healthHeight').value),
                    vaccination: document.getElementById('vaccinationStatus').value,
                    notes: document.getElementById('healthNotes').value,
                    date: new Date().toISOString()
                };
                
                let records = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                records.push(record);
                localStorage.setItem('healthRecords', JSON.stringify(records));
                
                alert('Health record added successfully!');
                document.getElementById('addHealthModal').classList.remove('active');
                document.getElementById('addHealthForm').reset();
                
                // Refresh data
                this.loadHealthData();
                this.updateOverview();
                
                // Switch to health tab
                this.switchTab('health');
            }
            
            addEducationRecord() {
                const record = {
                    id: 'edu_' + Date.now(),
                    childId: this.childId,
                    subject: document.getElementById('educationSubject').value,
                    marks: document.getElementById('educationMarks').value,
                    examType: document.getElementById('examType').value,
                    date: document.getElementById('educationDate').value,
                    feedback: document.getElementById('educationFeedback').value,
                    recordedAt: new Date().toISOString()
                };
                
                let records = JSON.parse(localStorage.getItem('educationRecords') || '[]');
                records.push(record);
                localStorage.setItem('educationRecords', JSON.stringify(records));
                
                alert('Education record added successfully!');
                document.getElementById('addEducationModal').classList.remove('active');
                document.getElementById('addEducationForm').reset();
                
                // Refresh data
                this.loadEducationData();
                this.updateOverview();
                
                // Switch to education tab
                this.switchTab('education');
            }
            
            addActivity() {
                const activity = {
                    id: 'act_' + Date.now(),
                    childId: this.childId,
                    type: document.getElementById('activityType').value,
                    description: document.getElementById('activityDescription').value,
                    duration: parseInt(document.getElementById('activityDuration').value),
                    date: document.getElementById('activityDate').value,
                    recordedAt: new Date().toISOString()
                };
                
                let activities = JSON.parse(localStorage.getItem('activities') || '[]');
                activities.push(activity);
                localStorage.setItem('activities', JSON.stringify(activities));
                
                alert('Activity added successfully!');
                document.getElementById('addActivityModal').classList.remove('active');
                document.getElementById('addActivityForm').reset();
                
                // Refresh data
                this.loadActivitiesData();
                this.updateOverview();
                
                // Switch to activities tab
                this.switchTab('activities');
            }
            
            redirectToDashboard() {
                const user = this.currentUser;
                if (user.role === 'parent') {
                    window.location.href = 'parent-dashboard.html';
                } else if (user.role === 'expert') {
                    window.location.href = 'expert-dashboard.html';
                } else if (user.role === 'admin') {
                    window.location.href = 'admin-dashboard.html';
                } else {
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Initialize child profile
        document.addEventListener('DOMContentLoaded', () => {
            window.childProfile = new ChildProfile();
        });
    </script>
</body>
</html>